{% extends "base.html" %}

{% block title %}{{ product.titel }} - Preisvergleich - GÃ¼nstiger Gefunden{% endblock %}

{% block extra_css %}
<style>
    .product-detail-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .product-main {
        display: grid;
        gap: 30px;
    }

    @media (min-width: 768px) {
        .product-main {
            grid-template-columns: 1fr 1fr;
        }
    }

    .product-gallery {
        position: relative;
    }

    .main-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .product-info h1 {
        font-size: 24px;
        color: #232f3e;
        margin-bottom: 15px;
        line-height: 1.3;
    }

    .price-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .best-price-large {
        font-size: 32px;
        font-weight: bold;
        color: #b12704;
        margin-bottom: 10px;
    }

    .shop-price-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .shop-price-table th,
    .shop-price-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .shop-price-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #555;
    }

    .buy-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 24px;
        background: #ff9900;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        transition: background 0.2s;
    }

    .buy-btn:hover {
        background: #e68a00;
        color: white;
        text-decoration: none;
    }

    .related-products {
        margin-top: 40px;
    }

    .related-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="Breadcrumb" class="mb-4">
        <ol style="display: flex; gap: 10px; list-style: none; padding: 0; font-size: 14px;">
            <li><a href="/">Startseite</a></li>
            <li>â€º</li>
            <li><a href="/search?q={{ product.titel|urlencode }}">Produkte</a></li>
            <li>â€º</li>
            <li aria-current="page">{{ product.titel|truncate(50) }}</li>
        </ol>
    </nav>

    <div class="product-detail-container">
        <div class="product-main">
            <!-- Product Images -->
            <div class="product-gallery">
                <img src="/static{{ product.bild_pfad }}"
                     alt="{{ product.titel }}"
                     class="main-image"
                     loading="eager">

                {% if product.label %}
                <div class="badge badge-{{ 'bestseller' if product.label == 'Bestseller' else 'new' if product.label == 'New' else 'sale' }}"
                     style="position: absolute; top: 10px; left: 10px;">
                    {{ product.label }}
                </div>
                {% endif %}
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <h1 itemprop="name">{{ product.titel }}</h1>

                <!-- Star Ratings -->
                {% if product.bewertung_durchschnitt and product.bewertung_anzahl %}
                <div class="star-rating" itemprop="aggregateRating"
                     itemscope itemtype="https://schema.org/AggregateRating">
                    <meta itemprop="ratingValue" content="{{ product.bewertung_durchschnitt }}">
                    <meta itemprop="reviewCount" content="{{ product.bewertung_anzahl }}">
                    <meta itemprop="bestRating" content="5">
                    <meta itemprop="worstRating" content="1">

                    <div class="stars">
                        {% for i in range(1, 6) %}
                            {% if product.bewertung_durchschnitt >= i %}
                                <span class="star filled">â˜…</span>
                            {% elif product.bewertung_durchschnitt >= i - 0.5 %}
                                <span class="star half">â˜…</span>
                            {% else %}
                                <span class="star">â˜†</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="rating-text">
                        {{ "%.1f"|format(product.bewertung_durchschnitt) }}
                        <span class="rating-count">({{ product.bewertung_anzahl }} Bewertungen)</span>
                    </span>
                </div>
                {% endif %}

                <!-- Description -->
                {% if product.beschreibung %}
                <div class="product-description mt-4">
                    <h3>Produktbeschreibung</h3>
                    <p>{{ product.beschreibung }}</p>
                </div>
                {% endif %}

                <!-- Price Comparison -->
                <div class="price-section">
                    <h3>Preisvergleich</h3>

                    {% if prices %}
                    <div class="best-price-large">
                        {{ "%.2f"|format(prices[0].aktueller_preis) }} â‚¬
                    </div>
                    <p>GÃ¼nstigster Preis bei {{ prices[0].name }}</p>

                    <table class="shop-price-table">
                        <thead>
                            <tr>
                                <th>Shop</th>
                                <th>Preis</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in prices %}
                            <tr>
                                <td>
                                    <strong>{{ price.name }}</strong>
                                    <span class="d-block small text-muted">
                                        {% if price.name == 'Amazon' %}Schnelle Lieferung
                                        {% elif price.name == 'Otto' %}Deutscher HÃ¤ndler
                                        {% elif price.name == 'AliExpress' %}Internationaler Versand
                                        {% elif price.name == 'Temu' %}GÃ¼nstige Preise
                                        {% elif price.name == 'Kaufland' %}VerfÃ¼gbar im Markt
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <strong class="text-danger">{{ "%.2f"|format(price.aktueller_preis) }} â‚¬</strong>
                                </td>
                                <td>
                                    <a href="{{ price.link }}"
                                       class="buy-btn"
                                       target="_blank"
                                       rel="noopener nofollow"
                                       aria-label="Bei {{ price.name }} kaufen fÃ¼r {{ price.aktueller_preis }}â‚¬">
                                        <span>ðŸ›’</span>
                                        Zum Shop
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Derzeit sind keine Preise verfÃ¼gbar.</p>
                    {% endif %}
                </div>

                <!-- Add to cart -->
                <div class="mt-4">
                    <button class="add-to-cart-btn w-100"
                            onclick="addToCart({{ product.id }})"
                            aria-label="{{ product.titel }} zum Warenkorb hinzufÃ¼gen">
                        ðŸ›’ In den Warenkorb
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    {% if related %}
    <div class="related-products mt-5">
        <h2>Ã„hnliche Produkte</h2>
        <div class="related-grid">
            {% for rel in related %}
            <div class="product-card">
                <div class="product-image">
                    <img src="/static/{{ rel.bild }}"
                         alt="{{ rel.titel }}"
                         loading="lazy"
                         class="lazy-load"
                         data-src="/static/{{ rel.bild }}">
                </div>
                <div class="product-info">
                    <h4>
                        <a href="/product/{{ rel.id }}" class="product-title">
                            {{ rel.titel|truncate(60) }}
                        </a>
                    </h4>
                    {% if rel.min_price %}
                    <div class="best-price">{{ "%.2f"|format(rel.min_price) }} â‚¬</div>
                    {% endif %}
                    <a href="/product/{{ rel.id }}" class="btn btn-sm btn-outline-primary w-100 mt-2">
                        Details ansehen
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Schema.org Product Markup -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": "{{ product.titel }}",
        "description": "{{ product.beschreibung|striptags|truncate(200) }}",
        "image": "{{ request.url_root.rstrip('/') }}/static{{ product.bild_pfad }}",
        {% if product.bewertung_durchschnitt and product.bewertung_anzahl %}
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "{{ product.bewertung_durchschnitt }}",
            "reviewCount": "{{ product.bewertung_anzahl }}",
            "bestRating": "5",
            "worstRating": "1"
        },
        {% endif %}
        "offers": {
            "@type": "AggregateOffer",
            "priceCurrency": "EUR",
            "lowPrice": "{{ prices[0].aktueller_preis if prices else '0.00' }}",
            "highPrice": "{{ prices[-1].aktueller_preis if prices else '0.00' }}",
            "offerCount": "{{ prices|length }}",
            "offers": [
                {% for price in prices %}
                {
                    "@type": "Offer",
                    "url": "{{ price.link }}",
                    "priceCurrency": "EUR",
                    "price": "{{ price.aktueller_preis }}",
                    "seller": {
                        "@type": "Organization",
                        "name": "{{ price.name }}"
                    },
                    "availability": "https://schema.org/InStock"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }
    }
    </script>
</div>

<script>
    function addToCart(productId) {
        const quantity = 1;

        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', quantity);

        fetch('/cart/add', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.redirect) {
                window.location.href = data.redirect;
            } else if (data.success) {
                // Update cart count
                const cartCounts = document.querySelectorAll('.cart-count');
                cartCounts.forEach(countEl => {
                    countEl.textContent = data.count;
                    countEl.style.display = 'flex';
                });

                // Show success message
                const btn = document.querySelector('.add-to-cart-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ… Zum Warenkorb hinzugefÃ¼gt';
                btn.style.background = '#28a745';
                btn.style.borderColor = '#218838';
                btn.disabled = true;

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#ffd814';
                    btn.style.borderColor = '#fcd200';
                    btn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim HinzufÃ¼gen zum Warenkorb');
        });
    }
</script>
{% endblock %}
